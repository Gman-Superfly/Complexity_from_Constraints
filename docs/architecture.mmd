%% Complexity from Constraints - Architecture Diagram (Mermaid)


flowchart TD
    %% Inputs
    IN[Inputs\n- Sequence (values)\n- Grid (n, p, shortcuts)\n- Context for gating gain] --> MUX

    %% Modules compute order parameters
    subgraph MODULES[Small Modules (η, F_local)]
        direction TB
        SEQ[SequenceConsistencyModule\nη_seq ∈ [0,1]\nF_seq(η; a,b)]:::mod
        CONN[ConnectivityModule\nη_conn ∈ [0,1]\nF_conn(η; a,b)]:::mod
        GATE[EnergyGatingModule\nη_gate = σ(k·(gain−cost))\nF_gate(η; a,b)]:::mod
    end

    MUX((Demux)) --> SEQ
    MUX --> CONN
    MUX --> GATE

    %% Couplings
    subgraph COUPLINGS[Sparse Non-Local Couplings (F_couple)]
        direction TB
        QUAD[QuadraticCoupling\nw·(η_i − η_j)^2]:::cpl
        HINGE[DirectedHingeCoupling\nw·max(0, η_j − η_i)^2]:::cpl
        GBC[GateBenefitCoupling\n− w · η_gate · Δη_domain]:::cpl
    end

    %% Coordinator aggregates energy
    FACC[Compute F_total\nΣ F_local + Σ F_couple]:::op
    RELAX{Coordinator\nrelax η (ΔF < 0)?}:::op
    OUT[Coherent State\nLower F_total]:::res
    LOG[Logs (Polars CSV)\nη, F_local, F_couple, ΔF,\nredemption, rates]:::log

    SEQ --> FACC
    CONN --> FACC
    GATE --> FACC
    COUPLINGS --> FACC
    FACC --> RELAX
    RELAX -->|yes| OUT
    RELAX -->|events| LOG
    RELAX -->|iterate| FACC

    %% Gate coupling semantics
    GATE -. provides η_gate .-> GBC
    SEQ -. provides Δη_seq .-> GBC
    CONN -. provides Δη_conn .-> GBC
    GBC -. contributes to .-> FACC

    %% Legend
    classDef mod fill:#f7fbff,stroke:#08306b,stroke-width:1.2;
    classDef cpl fill:#fff7fb,stroke:#6a1b9a,stroke-width:1.2,stroke-dasharray: 3 3;
    classDef op fill:#f9fbe7,stroke:#3e2723,stroke-width:1.2;
    classDef res fill:#e8f5e9,stroke:#1b5e20,stroke-width:1.2;
    classDef log fill:#f3e5f5,stroke:#4a148c,stroke-width:1.2;


