# SmallGain Allocator Validation (Quick Sweep)

This document summarizes a quick validation sweep of the SmallGain stability‑margin allocator across baseline and dense scenarios. The goal is to characterize performance across budget fraction ρ and per‑step max Δweight settings, using ΔF90 (steps to reach 90% of total energy drop), total backtracks, final energy, and wall‑time.

## How to reproduce (Windows/uv)

```powershell
# Quick sweep (fast): steps=40, dense_size=8
uv run python -m experiments.sweeps.sweep_smallgain --quick --run_id_prefix sg_sw_quick

# Full sweep (default steps=80, dense_size=16)
uv run python -m experiments.sweeps.sweep_smallgain --run_id_prefix sg_sw_full
```

The sweep writes per‑run rows to `logs/benchmark_delta_f90.csv` and a compact summary to `plots/df90_smallgain_sweep_summary.csv`.

## Results (Quick Sweep)

Source: `plots/df90_smallgain_sweep_summary.csv` generated by the quick sweep.

### Baseline scenario

| ρ | Δweight | ΔF90 steps (↓) | total_backtracks | energy_final | wall_time_sec |
|---|---------|-----------------|------------------|--------------|---------------|
| 0.5 | 0.05 | 9 | 10 | -0.007357 | 0.014260 |
| 0.5 | 0.10 | 10 | 10 | -0.020079 | 0.004272 |
| 0.5 | 0.20 | 7 | 13 | -0.018973 | 0.009702 |
| 0.7 | 0.05 | 9 | 10 | -0.007357 | 0.010644 |
| 0.7 | 0.10 | 10 | 10 | -0.020079 | 0.006677 |
| 0.7 | 0.20 | 7 | 13 | -0.018973 | 0.007852 |
| 0.9 | 0.05 | 9 | 10 | -0.007357 | 0.009157 |
| 0.9 | 0.10 | 10 | 10 | -0.020079 | 0.007997 |
| 0.9 | 0.20 | 7 | 13 | -0.018973 | 0.009237 |

Observations (baseline):
- ΔF90 steps are lowest (best) at Δweight=0.20 (7 steps), across ρ; energy_final is best at Δweight=0.10 (≈ -0.02008) with fewer backtracks.
- Recommendation: default Δweight=0.10, ρ≈0.7 remains a solid compromise (good final energy, low backtracks), while Δweight=0.20 is a speed‑leaning option (fewer steps) with modest backtrack increase.

### Dense scenario

| ρ | Δweight | ΔF90 steps (↓) | total_backtracks | energy_final | wall_time_sec |
|---|---------|-----------------|------------------|--------------|---------------|
| 0.5 | 0.05 | 17 | 21 | -0.037021 | 0.029084 |
| 0.5 | 0.10 | 12 | 57 | -0.046499 | 0.072858 |
| 0.5 | 0.20 | 7 | 35 | -0.044301 | 0.059012 |
| 0.7 | 0.05 | 17 | 21 | -0.037021 | 0.037151 |
| 0.7 | 0.10 | 12 | 57 | -0.046499 | 0.054444 |
| 0.7 | 0.20 | 7 | 35 | -0.044301 | 0.054543 |
| 0.9 | 0.05 | 17 | 21 | -0.037021 | 0.038645 |
| 0.9 | 0.10 | 12 | 57 | -0.046499 | 0.030028 |
| 0.9 | 0.20 | 7 | 35 | -0.044301 | 0.040974 |

Observations (dense):
- ΔF90 steps are again lowest at Δweight=0.20 (7 steps), but energy_final is strongest at Δweight=0.10 (≈ -0.0465) with higher backtracks.
- Recommendation mirrors baseline: Δweight=0.10 is a conservative default (strong final energy), Δweight=0.20 reduces steps with moderate backtracks/time increase. ρ in {0.7, 0.9} shows similar behavior.

## Takeaways
- Defaults remain reasonable: ρ=0.7, Δweight=0.10 balance stability (backtracks) and final energy, consistent with earlier guidance.
- If optimizing for fastest approach to 90% energy reduction (ΔF90), Δweight=0.20 is attractive; expect moderately higher backtracks and slightly weaker final energy.

## Next (Full Validation)
- Run the full sweep and add comparisons vs GradNorm and no‑adapt baselines.
- Extend plots to show rank by `redemption_gain` and contraction margin health over time for each setting.

## Scope and Generalization
- The findings above come from the baseline and dense toy scenarios; they are strong defaults but not universal optima. Expect shifts with different module graphs, gate activity regimes, hinge thresholds, and homotopy settings.

## Fixed vs Learned Hyperparameters
- What SmallGain learns now: per-step, per-edge allocations (how to spend within a step).
- What’s fixed: the outer caps — ρ (budget fraction) and Δweight (per‑step max weight change).
- Why keep fixed:
  - Reproducibility and predictable stability (important in safety/regulated contexts).
  - Easier comparisons across experiments and clearer failure analysis.
- When to learn/tune:
  - Non‑stationary data, changing event flows, or when optimizing a portfolio KPI (e.g., maximize redemption_gain under backtrack constraints).
  - Practical path: outer‑loop tuning (grid/Bayesian) over ρ and Δweight using `experiments/sweeps/sweep_smallgain.py`, pick settings by ΔF90/backtracks/redemption_gain.
  - Advanced path: state‑adaptive caps (e.g., ρ as a function of contraction margin and hinge activity) with conservative bounds to retain stability guarantees.

# SmallGain Allocator Validation (Initial)

This note summarizes the initial ΔF90 validation and budget telemetry for the SmallGain stability‑margin allocator.

## Setup

Harness: `experiments/benchmark_delta_f90.py`

- Baseline presets: `analytic`, `vect`, `prox`, `prox_star`
- Adapters: `gradnorm`, `smallgain`
- Flags:
  - Budget logging: `--log_budget --budget_name benchmark_delta_f90_budget`
  - SmallGain sweep (optional): `--sg_rho {0.5,0.7,0.9}`, `--sg_dw {0.05,0.10,0.20}`

Example runs:

```powershell
uv run python -m experiments.benchmark_delta_f90 --configs analytic gradnorm smallgain --steps 60 --run_id sg_smoke --log_budget --budget_name benchmark_delta_f90_budget
uv run python -m experiments.benchmark_delta_f90 --configs vect smallgain prox_star --scenario dense --dense_size 32 --steps 60 --run_id sg_dense --log_budget --budget_name benchmark_delta_f90_budget
```

## Initial Results (from logs/benchmark_delta_f90.csv)

- Baseline (sg_smoke): ΔF90(analytic)=22, ΔF90(gradnorm)=10, ΔF90(smallgain)=10
- Dense (sg_dense): ΔF90(vect)=24, ΔF90(prox_star)=12, ΔF90(smallgain)=12

Interpretation: SmallGain matches GradNorm on the baseline toy and halves ΔF90 vs a vectorized baseline on dense graphs, at higher wall time. This is acceptable for a conservative allocator; defaults remain reasonable.

## Budget Telemetry and Plots

Per‑step budget CSV: `logs/benchmark_delta_f90_budget.csv`.

Quick plot for spend vs contraction margin and totals:

```powershell
uv run python -m experiments.plots.plot_budget_vs_spend --input logs\benchmark_delta_f90_budget.csv --run_id sg_dense_smallgain --out plots\budget_vs_spend_smallgain_dense.png
```

The plot includes:
- `spent:global`: accumulated ΔL spend
- `alloc:total`: sum of alloc:* columns (per‑step allocation totals)
- `cost:total`: sum of cost:* columns (family-level costs)
- Optional `contraction_margin` (when `stability_guard=True`)

## Parameter Sweep (dense)

```powershell
$rhos = @(0.5, 0.7, 0.9)
$dws  = @(0.05, 0.1, 0.2)
foreach ($rho in $rhos) {
  foreach ($dw in $dws) {
    $rid = ("sg_sweep_rho{0}_dw{1}" -f $rho,$dw)
    uv run python -m experiments.benchmark_delta_f90 --configs smallgain --steps 60 --scenario dense --dense_size 32 --sg_rho $rho --sg_dw $dw --run_id $rid --log_budget --budget_name benchmark_delta_f90_budget
  }
}
```

Observation (initial): Higher per‑step caps (Δweight≈10–20%) with ρ≥0.7 yield the best ΔF90 in dense; current defaults (ρ=0.7, Δweight=10%) remain reasonable.

## Next

- Repeat sweep on ring and sequence+gate suites
- Summarize ΔF90/backtracks/runtime in a compact table
- If stable, consider enabling row‑aware allocator by default under `stability_guard=True` (still marked experimental) 


